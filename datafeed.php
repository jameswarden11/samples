<?## PHP Calendar for use with ROOT2020.com## James Warden 2016session_start();$userid = $_SESSION["socialid"];include_once("dbconfig.php");include_once("functions.php");$timezone = "America/Chicago";date_default_timezone_set($timezone);function addCalendar($st, $et, $sub, $ade){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();    $sql = "insert into `jqcalendar` (`subject`, `starttime`, `endtime`, `isalldayevent`) values ('"      .mysql_real_escape_string($sub)."', '"      .php2MySqlTime(js2PhpTime($st))."', '"      .php2MySqlTime(js2PhpTime($et))."', '"      .mysql_real_escape_string($ade)."' )";    //echo($sql);		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'add success';      $ret['Data'] = mysql_insert_id();    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function addDetailedCalendar($st, $et, $sub, $ade, $dscr, $loc, $color, $tz){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();    $sql = "insert into `jqcalendar` (`subject`, `starttime`, `endtime`, `isalldayevent`, `description`, `location`, `color`) values ('"      .mysql_real_escape_string($sub)."', '"      .php2MySqlTime(js2PhpTime($st))."', '"      .php2MySqlTime(js2PhpTime($et))."', '"      .mysql_real_escape_string($ade)."', '"      .mysql_real_escape_string($dscr)."', '"      .mysql_real_escape_string($loc)."', '"      .mysql_real_escape_string($color)."' )";    //echo($sql);		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'add success';      $ret['Data'] = mysql_insert_id();    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function listCalendarByRange($sd, $ed, $userid, $category){  $ret = array();  $ret['events'] = array();  $ret["issort"] =true;  $ret["start"] = php2JsTime($sd);  $ret["end"] = php2JsTime($ed);  $ret['error'] = null;  $therange = strtotime(php2MySqlTime($ed));  $therange = date("Y-m-d H:i:s", strtotime("+30 days", $therange));  try{    $db = new DBConnection();    $db->getConnection();    $sql = "select * from `goals$userid` WHERE `deadline2` BETWEEN '"      .php2MySqlTime($sd)."' AND '". php2MySqlTime($ed) ."' AND discarded='0' ORDER BY deadline2";      if (isset($category)) {      $sql = "select * from `goals$userid` WHERE `deadline2` BETWEEN '"      .php2MySqlTime($sd)."' AND '". php2MySqlTime($ed) ."' AND discarded='0' AND categories LIKE '%$category%' ORDER BY deadline2";      }    $handle = mysql_query($sql); ## echo $sql; ##  echo mysql_error();	  $one_week = 7 * 24 * 60 * 60;	  $two_weeks = 14 * 24 * 60 * 60;	  $two_days = 2 * 24 * 60 * 60;	  $three_days = 3 * 24 * 60 * 60;	  $four_days = 4 * 24 * 60 * 60;	  $five_days = 5 * 24 * 60 * 60;	  $six_days = 6 * 24 * 60 * 60;	  $one_day = 1 * 24 * 60 * 60;	  $one_month = 30 * 24 * 60 * 60;	  $two_months = 60 * 24 * 60 * 60;	  $three_months = 90 * 24 * 60 * 60;	  $six_months = 180 * 24 * 60 * 60;	  $nine_months = 270 * 24 * 60 * 60;	  $one_year = 360 * 24 * 60 * 60;	  $one_year_half = 540 * 24 * 60 * 60;	  $two_years = 720 * 24 * 60 * 60;	  $three_years = 1080 * 24 * 60 * 60;	  $four_years = 1440 * 24 * 60 * 60;	  $five_years = 1800 * 24 * 60 * 60;	  $ten_years = 3600 * 24 * 60 * 60;	  $one_week2 = 8 * 24 * 60 * 60;	  $two_weeks2 = 15 * 24 * 60 * 60;	  $two_days2 = 3 * 24 * 60 * 60;	  $one_day2 = 2 * 24 * 60 * 60;	  $one_month2 = 31 * 24 * 60 * 60;	  $two_months2 = 61 * 24 * 60 * 60;	  $three_months2 = 91 * 24 * 60 * 60;	  $six_months2 = 181 * 24 * 60 * 60;	  $nine_months2 = 271 * 24 * 60 * 60;	  $one_year2 = 361 * 24 * 60 * 60;	  $one_year_half2 = 541 * 24 * 60 * 60;	  $two_years2 = 721 * 24 * 60 * 60;	  $three_years2 = 1081 * 24 * 60 * 60;	  $four_years2 = 1441 * 24 * 60 * 60;	  $five_years2 = 1801 * 24 * 60 * 60;	  $ten_years2 = 3601 * 24 * 60 * 60;	  $three_days2 = 4 * 24 * 60 * 60;	  $four_days2 = 5 * 24 * 60 * 60;	  $five_days2 = 6 * 24 * 60 * 60;	  $six_days2 = 7 * 24 * 60 * 60;$plus_day = 0;$day_ahead = 0;$day_ahead2 = 0;$agoalid[0] = "";$adeadline2[0] = "";$adeadline3[0] = "";$acolor[0] = "";$asummary[0] = "";$aeditable[0] = "";$as = 0;    while ($row = mysql_fetch_object($handle)) {     $type = $row->type;     $stages = $row->stages;      $selection = $row->selection;     $deadline2 = $row->deadline2;      $deadline3 = $row->deadline3;      $status = $row->status;  $ts = time();$counter = 0;$deadline = date("Y-m-d");$today = date("Y-m-d");$deadlineb = date("Y-m-d", strtotime($deadline2));while ($counter <= 300 && $type == "0" && $stages == "-1") {     $starttime = date("H:i:s", strtotime($deadline2));	  $endtime = date("H:i:s", strtotime($deadline3));if ($selection == "0" && $counter == 0) {$day_ahead = 0;$day_ahead2 = 0;}	  if ($selection == "1" || $counter > 0 && $selection == "0") {	  $day_ahead = $one_day;	  $day_ahead2 = $one_day;	  if ($plusday == 1) {	  $day_ahead2 = $one_day2;	  }	  }	  if ($selection == "2") {	  $day_ahead = $two_days;	  $day_ahead2 = $two_days;	  if ($plusday == 1) {	  $day_ahead2 = $two_days2;	  }	  }	  if ($selection == "24") {	  $day_ahead = $three_days;	  $day_ahead2 = $three_days;	  if ($plusday == 1) {	  $day_ahead2 = $three_days2;	  }	  }	  if ($selection == "25") {	  $day_ahead = $four_days;	  $day_ahead2 = $four_days;	  if ($plusday == 1) {	  $day_ahead2 = $four_days2;	  }	  }	  if ($selection == "26") {	  $day_ahead = $five_days;	  $day_ahead2 = $five_days;	  if ($plusday == 1) {	  $day_ahead2 = $five_days2;	  }	  }	  if ($selection == "27") {	  $day_ahead = $six_days;	  $day_ahead2 = $six_days;	  if ($plusday == 1) {	  $day_ahead2 = $six_days2;	  }	  }	  if ($selection == "3") {	  $day_ahead = $one_week;	  $day_ahead2 = $one_week;	  if ($plusday == 1) {	  $day_ahead2 = $one_week2;	  }	  }	  if ($selection == "4") {	  $day_ahead = $two_weeks;	  $day_ahead2 = $two_weeks;	  if ($plusday == 1) {	  $day_ahead2 = $two_weeks2;	  }	  }	  if ($selection == "5") {	  $day_ahead = $one_month;	  $day_ahead2 = $one_month;	  if ($plusday == 1) {	  $day_ahead2 = $one_month2;	  }	  }	  if ($selection == "6") {	  $day_ahead = $two_months;	  $day_ahead2 = $two_months;	  if ($plusday == 1) {	  $day_ahead2 = $two_months2;	  }	  }	  if ($selection == "7") {	  $day_ahead = $three_months;	  $day_ahead2 = $three_months;	  if ($plusday == 1) {	  $day_ahead2 = $three_months2;	  }	  }	  if ($selection == "8") {	  $day_ahead = $six_months;	  $day_ahead2 = $six_months;	  if ($plusday == 1) {	  $day_ahead2 = $six_months2;	  }	  }	  if ($selection == "9") {	  $day_ahead = $nine_months;	  $day_ahead2 = $nine_months;	  if ($plusday == 1) {	  $day_ahead2 = $nine_months2;	  }	  }	  if ($selection == "10") {	  $day_ahead = $one_year;	  $day_ahead2 = $one_year;	  if ($plusday == 1) {	  $day_ahead2 = $one_year2;	  }	  }	  if ($selection == "11") {	  $day_ahead = $one_year_half;	  $day_ahead2 = $one_year_half;	  if ($plusday == 1) {	  $day_ahead2 = $one_year_half2;	  }	  }	  if ($selection == "12") {	  $selection = $two_years;	  $day_ahead2 = $two_years;	  if ($plusday == 1) {	  $day_ahead2 = $two_years2;	  }	  }	  if ($selection == "13") {	  $day_ahead = $three_years;	  $day_ahead2 = $three_years;	  if ($plusday == 1) {	  $day_ahead2 = $three_years2;	  }	  }	  if ($selection == "14") {	  $day_ahead = $four_years;	  $day_ahead2 = $four_years;	  if ($plusday == 1) {	  $day_ahead2 = $four_years2;	  }	  }	  if ($selection == "15") {	  $day_ahead = $five_years;	  $day_ahead2 = $five_years;	  if ($plusday == 1) {	  $day_ahead2 = $five_years2;	  }	  }	  if ($selection == "16") {	  $day_ahead = $ten_years;	  $day_ahead2 = $ten_years;	  if ($plusday == 1) {	  $day_ahead2 = $ten_years2;	  }	  }	  if ($selection == 17) {if ($counter > 0) {	  $deadlineb = date("Y-m-d", strtotime("next monday", $ts) );}	  $deadlineb2 = $deadlineb;	  $deadline2 = $deadlineb . " " . $starttime;	  $deadline3 = $deadlineb2 . " " . $endtime;	  }	  if ($selection == 18) {if ($counter > 0) {	  $deadlineb = date("Y-m-d", strtotime("next tuesday", $ts) );}	  $deadlineb2 = $deadlineb;	  $deadline2 = $deadlineb . " " . $starttime;	  $deadline3 = $deadlineb2 . " " . $endtime;	  }	  if ($selection == 19) {if ($counter > 0) {	  $deadlineb = date("Y-m-d", strtotime("next wednesday", $ts) );}	  $deadlineb2 = $deadlineb;	  $deadline2 = $deadlineb . " " . $starttime;	  $deadline3 = $deadlineb2 . " " . $endtime;	  }	  if ($selection == 20) {if ($counter > 0) {	  $deadlineb = date("Y-m-d", strtotime("next thursday", $ts) );}	  $deadlineb2 = $deadlineb;	  $deadline2 = $deadlineb . " " . $starttime;	  $deadline3 = $deadlineb2 . " " . $endtime;	  }	  if ($selection == 21) {if ($counter > 0) {	  $deadlineb = date("Y-m-d", strtotime("next friday", $ts) );}	  $deadlineb2 = $deadlineb;	  $deadline2 = $deadlineb . " " . $starttime;	  $deadline3 = $deadlineb2 . " " . $endtime;	  }	  if ($selection == 22) {if ($counter > 0) {	  $deadlineb = date("Y-m-d", strtotime("next saturday", $ts) );}	  $deadlineb2 = $deadlineb;	  $deadline2 = $deadlineb . " " . $starttime;	  $deadline3 = $deadlineb2 . " " . $endtime;	  }	  if ($selection == 23) {if ($counter > 0) {	  $deadlineb = date("Y-m-d", strtotime("next sunday", $ts) );}	  $deadlineb2 = $deadlineb;	  $deadline2 = $deadlineb . " " . $starttime;	  $deadline3 = $deadlineb2 . " " . $endtime;	  }	  if ($selection < 17 && $day_ahead > 0) {	  $deadline = date( "Y-m-d", ( $ts + $day_ahead ) );	  $deadline_3 = date( "Y-m-d", ( $ts + $day_ahead ) );	  $deadline2 = $deadline . " " . $starttime;	  $deadline3 = $deadline_3 . " " . $endtime;	  }	  if ($selection >= 24) {	  $deadline = date( "Y-m-d", ( $ts + $day_ahead ) );	  $deadline_3 = date( "Y-m-d", ( $ts + $day_ahead2 ) );	  $deadline2 = $deadline . " " . $starttime;	  $deadline3 = $deadline_3 . " " . $endtime;}$newts = strtotime($deadline2);$ts = $newts;$deadline = date("Y-m-d", strtotime($deadline2));      $color = 20;      if ($type == "0" && $today == $deadline) {      $color = 9;      }$agoalid[$as] = $row->goalid;$asummary[$as] = $row->summary;$adeadline2[$as] = php2JsTime(mySql2PhpTime($deadline2));$adeadline3[$as] = php2JsTime(mySql2PhpTime($deadline3));$acolor[$as] = $color;$aeditable[$as] = 1;    $counter++;$as++;    }	$deadline = date("Y-m-d", strtotime($deadline2));    if ($type == "0" && $today == $deadline) {	      $color = 9;	      }	      if ($type == "0" && $today != $deadline) {	      $color = 20;	      }    if ($type == "1") {	      $color = 6;	      }	      if ($type >= 2) {	      $color = 5;      }if ($status == "2") {$color = 17;}	if ($type == 2 || $type == 0 && $stages != "-1") {$agoalid[$as] = $row->goalid;$asummary[$as] = $row->summary;$adeadline2[$as] = php2JsTime(mySql2PhpTime($row->deadline2));$adeadline3[$as] = php2JsTime(mySql2PhpTime($row->deadline3));$acolor[$as] = $color;$aeditable[$as] = 1;$as++;}	}	}	catch(Exception $e){     $ret['error'] = $e->getMessage();  }array_multisort($agoalid, SORT_ASC, $adeadline3, $adeadline2, $asummary, $acolor, $aeditable);$ret = "";for ($i=0;$i<$as;$i++) {	$ret['events'][] = array(	        $agoalid[$i],	        $asummary[$i],	        $adeadline2[$i],	        $adeadline3[$i],	        0, // is all day event	        0, //more than one day event	        0, //type	        $acolor[$i],//color,	        $aeditable[$i], //??,	        1,//editable	        1, //location	        ''//$attends      );}  return $ret;}function listCalendar($day, $type, $userid, $category){  $phpTime = js2PhpTime($day);  $phpTime = strtotime(date("Y-m-d H:i:s"));  $type = "month";  ##echo $phpTime . "+" . $type;  switch($type){    case "month":      $st = mktime(0, 0, 0, date("m", $phpTime), 1, date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime)+1, 1, date("Y", $phpTime));      break;    case "week":      //suppose first day of a week is monday      $monday  =  date("d", $phpTime) - date('N', $phpTime) + 1;      //echo date('N', $phpTime);      $st = mktime(0,0,0,date("m", $phpTime), $monday, date("Y", $phpTime));      $et = mktime(0,0,-1,date("m", $phpTime), $monday+7, date("Y", $phpTime));      break;    case "day":      $st = mktime(0, 0, 0, date("m", $phpTime), date("d", $phpTime), date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime), date("d", $phpTime)+1, date("Y", $phpTime));      break;  } ## echo $st . "--" . $et;  return listCalendarByRange($st, $et, $userid, $category);}function updateCalendar($id, $st, $et, $userid){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();    $sql = "update `goals$userid` set"      . " `deadline2`='" . php2MySqlTime(js2PhpTime($st)) . "', "      . " `deadline3`='" . php2MySqlTime(js2PhpTime($et)) . "' "      . "where `goalid`=" . $id;   // echo $sql;		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Succefully';    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function updateDetailedCalendar($id, $st, $et, $sub, $ade, $dscr, $loc, $color, $tz){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();    $sql = "update `goals$userid` set"      . " `deadline2`='" . php2MySqlTime(js2PhpTime($st)) . "', "      . " `deadline3`='" . php2MySqlTime(js2PhpTime($et)) . "', "      . " `summary`='" . mysql_real_escape_string($sub) . "', "      . "where `goalid`=" . $id; //   echo $sql;		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Succefully';    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function removeCalendar($id){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();    $sql = "delete from `jqcalendar` where `id`=" . $id;		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Succefully';    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}header('Content-type:text/javascript;charset=UTF-8');$method = $_GET["method"];$category = $_GET["category"];switch ($method) {    case "add":        $ret = addCalendar($_POST["CalendarStartTime"], $_POST["CalendarEndTime"], $_POST["CalendarTitle"], $_POST["IsAllDayEvent"]);        break;    case "list":        $ret = listCalendar($_POST["showdate"], $_POST["viewtype"], $userid, $category);        break;    case "update":        $ret = updateCalendar($_POST["calendarId"], $_POST["CalendarStartTime"], $_POST["CalendarEndTime"], $userid);        break;    case "remove":        $ret = removeCalendar( $_POST["calendarId"]);        break;    case "adddetails":        $st = $_POST["stpartdate"] . " " . $_POST["stparttime"];        $et = $_POST["etpartdate"] . " " . $_POST["etparttime"];        if(isset($_GET["id"])){            $ret = updateDetailedCalendar($_GET["id"], $st, $et,                $_POST["Subject"], isset($_POST["IsAllDayEvent"])?1:0, $_POST["Description"],                $_POST["Location"], $_POST["colorvalue"], $_POST["timezone"]);        }else{            $ret = addDetailedCalendar($st, $et,                $_POST["Subject"], isset($_POST["IsAllDayEvent"])?1:0, $_POST["Description"],                $_POST["Location"], $_POST["colorvalue"], $_POST["timezone"]);        }        break;}echo json_encode($ret);?>